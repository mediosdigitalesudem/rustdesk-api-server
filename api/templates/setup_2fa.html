{% extends 'base.html' %}
{% load static %}

{% block title %}Setup Two-Factor Authentication{% endblock %}

{% block content %}
<div class="layui-container" style="padding-top: 20px;">
    <div class="layui-row">
        <div class="layui-col-md8 layui-col-md-offset2">
            <div class="layui-card">
                <div class="layui-card-header">
                    <h2>Setup Two-Factor Authentication (2FA)</h2>
                </div>
                <div class="layui-card-body">
                    <p>Scan the QR code below with your authenticator app (e.g., Google Authenticator, Authy, etc.).</p>
                    <p>Alternatively, you can manually enter the secret key.</p>

                    <div style="text-align: center; margin: 20px 0;">
                        <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code for 2FA">
                    </div>

                    <p style="text-align: center;">
                        <strong>Secret Key:</strong> <code>{{ otp_secret_key }}</code>
                    </p>

                    <hr>

                    <p>After scanning or entering the key, enter the 6-digit code generated by your authenticator app to confirm and enable 2FA.</p>

                    <form class="layui-form" method="post" action="{% url 'setup_2fa' %}">
                        {% csrf_token %}
                        <div class="layui-form-item">
                            <label class="layui-form-label" for="otp_code">OTP Code</label>
                            <div class="layui-input-block">
                                <input type="text" name="otp_code" id="otp_code" required lay-verify="required|number" autocomplete="off" class="layui-input" placeholder="Enter 6-digit code">
                            </div>
                        </div>

                        {% if error %}
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <p style="color: red;">{{ error }}</p>
                            </div>
                        </div>
                        {% endif %}

                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="confirmOtp">Confirm and Enable 2FA</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
layui.use(['form'], function(){
  var form = layui.form;

  // Custom verification rule (optional, lay-verify="required|number" already does a lot)
  form.verify({
    otpcode: function(value){
      if(value.length !== 6){
        return 'OTP code must be 6 digits.';
      }
    }
  });

  // Listener for form submission (optional if default form submission is fine)
  // form.on('submit(confirmOtp)', function(data){
  //   console.log(data.field) // current form field values
  //   // Explicitly submit the form if needed, or handle with AJAX
  //   // return true; // to allow normal form submission
  //   // return false; // to block normal form submission (e.g., if using AJAX)
  // });
});
</script>
{% endblock %}
